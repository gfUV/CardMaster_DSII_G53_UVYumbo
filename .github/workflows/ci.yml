name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - backup
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  # ==========================================
  # JOB 1: LINTING Y ANÁLISIS DE CÓDIGO
  # ==========================================
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # Backend Linting
      - name: Setup Node.js for Backend
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install Backend Dependencies
        working-directory: ./backend
        run: npm ci

      - name: Lint Backend Code
        working-directory: ./backend
        run: |
          npx eslint . --ext .js --max-warnings 0 || echo "⚠️ ESLint warnings found in backend"

      # Frontend Linting
      - name: Setup Node.js for Frontend
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Lint Frontend Code (TypeScript Check)
        working-directory: ./frontend
        run: npx tsc --noEmit

      - name: Check Code Formatting
        working-directory: ./frontend
        run: |
          npx prettier --check "src/**/*.{ts,css}" || echo "⚠️ Formatting issues found"

  # ==========================================
  # JOB 2: ANÁLISIS DE SEGURIDAD
  # ==========================================
  security:
    name: Security Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # Análisis de vulnerabilidades en dependencias del Backend
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Backend Security Audit
        working-directory: ./backend
        run: |
          npm audit --audit-level=moderate || echo "⚠️ Security vulnerabilities found in backend"

      - name: Frontend Security Audit
        working-directory: ./frontend
        run: |
          npm audit --audit-level=moderate || echo "⚠️ Security vulnerabilities found in frontend"

      # Análisis de secretos expuestos
      - name: Detect Secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --only-verified

      # Análisis de seguridad con CodeQL
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: javascript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

  # ==========================================
  # JOB 3: PRUEBAS UNITARIAS BACKEND
  # ==========================================
  test-backend:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install Dependencies
        working-directory: ./backend
        run: npm ci

      - name: Run Unit Tests
        working-directory: ./backend
        run: npm test
        env:
          NODE_ENV: test
          MONGO_URI: mongodb://localhost:27017/test
          JWT_SECRET: test_secret

      - name: Generate Coverage Report
        working-directory: ./backend
        run: npm run test:coverage || echo "⚠️ No coverage script configured"

      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./backend/coverage/lcov.info
          flags: backend
          fail_ci_if_error: false

  # ==========================================
  # JOB 4: PRUEBAS UNITARIAS FRONTEND
  # ==========================================
  test-frontend:
    name: Frontend Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run Unit Tests
        working-directory: ./frontend
        run: npm test || echo "⚠️ No tests configured yet"

      - name: Build Frontend
        working-directory: ./frontend
        run: npm run build

  # ==========================================
  # JOB 5: DESPLIEGUE A RENDER (BACKEND)
  # ==========================================
  deploy-backend:
    name: Deploy Backend to Render
    needs: [lint, security, test-backend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to Render (Backend)
        uses: johnbeynon/render-deploy-action@v0.0.8
        with:
          service-id: ${{ secrets.RENDER_BACKEND_SERVICE_ID }}
          api-key: ${{ secrets.RENDER_API_KEY }}

  # ==========================================
  # JOB 6: DESPLIEGUE A RENDER (FRONTEND)
  # ==========================================
  deploy-frontend:
    name: Deploy Frontend to Render
    needs: [lint, security, test-frontend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to Render (Frontend)
        uses: johnbeynon/render-deploy-action@v0.0.8
        with:
          service-id: ${{ secrets.RENDER_FRONTEND_SERVICE_ID }}
          api-key: ${{ secrets.RENDER_API_KEY }}

  # ==========================================
  # JOB 7: NOTIFICACIÓN DE RESULTADOS
  # ==========================================
  notify:
    name: Notify Results
    needs: [deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Send Success Notification
        if: ${{ needs.deploy-backend.result == 'success' && needs.deploy-frontend.result == 'success' }}
        run: |
          echo "✅ Deployment successful!"
          echo "Backend and Frontend deployed to Render"

      - name: Send Failure Notification
        if: ${{ needs.deploy-backend.result == 'failure' || needs.deploy-frontend.result == 'failure' }}
        run: |
          echo "❌ Deployment failed!"
          echo "Check the logs for more details"